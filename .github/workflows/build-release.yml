name: Build Release Executable

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  pull_request:
    branches:
      - main  # Build on PRs to main branch
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required to create releases and upload assets
  pull-requests: write  # Required to comment on PRs

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install -r requirements-windows.txt

    - name: Run tests
      run: |
        pytest -v

    - name: Build executable with PyInstaller
      run: |
        pyinstaller --onefile `
          --name "LMU_Telemetry_Logger" `
          --icon=NONE `
          --add-data "src;src" `
          --hidden-import psutil `
          --hidden-import datetime `
          --collect-all src `
          example_app.py

    - name: Create release package
      shell: bash
      run: |
        mkdir release
        cp dist/LMU_Telemetry_Logger.exe release/
        cp README.md release/
        cp USER_GUIDE.md release/
        cp CHANGELOG.md release/
        cp WINDOWS_BUILD_INSTRUCTIONS.md release/

        # Generate version info based on trigger type
        if [[ "${{ github.event_name }}" == "pull_request" ]]; then
          echo "LMU Telemetry Logger PR #${{ github.event.pull_request.number }} ($(git rev-parse --short HEAD))" > release/VERSION.txt
          echo "Build from: ${{ github.head_ref }}" >> release/VERSION.txt
        else
          echo "LMU Telemetry Logger ${GITHUB_REF_NAME}" > release/VERSION.txt
        fi

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: LMU_Telemetry_Logger-windows-${{ github.event_name == 'pull_request' && format('PR{0}', github.event.pull_request.number) || github.ref_name }}
        path: release/

    - name: Comment on PR with build artifact
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const artifactName = `LMU_Telemetry_Logger-windows-PR${{ github.event.pull_request.number }}`;
          const runId = context.runId;
          const repo = context.repo;

          const comment = `## âœ… Windows Build Complete

          The Windows executable has been built and is ready for testing!

          ### Download
          ðŸ“¦ [Download **${artifactName}**](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})

          Click the link above, scroll down to "Artifacts" section, and download the build.

          ### What's included
          - \`LMU_Telemetry_Logger.exe\` - Windows executable
          - \`README.md\`, \`USER_GUIDE.md\`, \`CHANGELOG.md\`
          - \`VERSION.txt\` - Build information

          ### Testing checklist
          - [ ] Run executable on Windows
          - [ ] Complete a player lap - verify no \`mCurrentET\` errors
          - [ ] Join multiplayer session
          - [ ] Wait for opponent to complete a lap
          - [ ] Check opponent lap filename has opponent's name
          - [ ] Check opponent CSV metadata has correct driver/car

          ---
          ðŸ¤– *Automated build from PR #${{ github.event.pull_request.number }}*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: repo.owner,
            repo: repo.repo,
            body: comment
          });

    - name: Get release notes
      id: release_notes
      if: startsWith(github.ref, 'refs/tags/')
      shell: bash
      run: |
        # Extract version from tag (e.g., v0.2.0 -> 0.2.0)
        VERSION=${GITHUB_REF_NAME#v}

        # Look for RELEASE_NOTES_v{version}.md
        RELEASE_NOTES_FILE="RELEASE_NOTES_v${VERSION}.md"

        if [ -f "$RELEASE_NOTES_FILE" ]; then
          echo "Using $RELEASE_NOTES_FILE"
          echo "body_file=$RELEASE_NOTES_FILE" >> $GITHUB_OUTPUT
        else
          echo "No release notes file found, using default"
          echo "body_file=" >> $GITHUB_OUTPUT
        fi

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          dist/LMU_Telemetry_Logger.exe
          README.md
          USER_GUIDE.md
          CHANGELOG.md
          WINDOWS_BUILD_INSTRUCTIONS.md
        body_path: ${{ steps.release_notes.outputs.body_file }}
        body: |
          ## LMU Telemetry Logger ${{ github.ref_name }}

          ### Features
          - Automatic telemetry capture from Le Mans Ultimate (player + opponents)
          - Opponent lap tracking (fastest lap only)
          - MVP format output (10-channel LMUTelemetry v3)
          - ~43-50 Hz capture rate (optimal)
          - File size: ~1 MB per lap
          - Smart file naming with track, car, driver, lap time

          ### Installation
          1. Install https://github.com/TheIronWolfModding/rF2SharedMemoryMapPlugin
            - This is included by "Simhub" and other popular tools, you may have it already
          2. Download `LMU_Telemetry_Logger.exe`
          3. Run the executable (no installation required)
          4. Launch LMU and start driving
          5. CSV files saved to `./telemetry_output/`

          ### Requirements
          - Windows 10/11
          - Le Mans Ultimate installed

          ### Documentation
          - See USER_GUIDE.md for detailed instructions
          - See CHANGELOG.md for full changelog
          - See WINDOWS_BUILD_INSTRUCTIONS.md to build from source
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
