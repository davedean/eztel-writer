name: Build Release Executable

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags like v1.0.0
  pull_request:
    branches:
      - main  # Build on PRs to main branch
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Required to create releases and upload assets
  pull-requests: write  # Required to comment on PRs

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r requirements-dev.txt
        pip install -r requirements-windows.txt

    - name: Run tests
      run: |
        pytest -v

    - name: Extract version from tag or commit
      id: get_version
      shell: bash
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          # Extract version from tag (e.g., v0.3.0 -> 0.3.0)
          VERSION=${GITHUB_REF_NAME#v}
        else
          # For PRs or non-tag pushes, read from src/__init__.py
          # Use sed and trim any whitespace/newlines
          VERSION=$(sed -n 's/^__version__ = "\(.*\)"/\1/p' src/__init__.py | tr -d '\r\n' | xargs)
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Detected version: $VERSION"

    - name: Build executable with PyInstaller
      run: |
        pyinstaller --onedir --noconsole `
          --name "1Lap" `
          --icon=NONE `
          --add-data "src;src" `
          --hidden-import psutil `
          --hidden-import datetime `
          --hidden-import pystray `
          --hidden-import PIL `
          --collect-all src `
          tray_app.py

    - name: Install Inno Setup
      run: |
        choco install innosetup -y

    - name: Build installer with Inno Setup
      shell: pwsh
      run: |
        # Find Inno Setup compiler
        $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        if (!(Test-Path $isccPath)) {
          Write-Error "Inno Setup compiler not found at: $isccPath"
          exit 1
        }

        Write-Output "Found Inno Setup at: $isccPath"

        $version = "${{ steps.get_version.outputs.version }}"
        Write-Output "Building installer with version: $version"

        # Run Inno Setup compiler with version parameter
        & $isccPath "/DMyAppVersion=$version" installer\1Lap_Setup.iss

        if ($LASTEXITCODE -ne 0) {
          Write-Error "Inno Setup compilation failed with exit code: $LASTEXITCODE"
          exit 1
        }

        # Verify installer was created (using dynamic version)
        $installerPath = "installer\output\1Lap_Setup_v$version.exe"
        if (!(Test-Path $installerPath)) {
          Write-Error "Installer was not created at: $installerPath"
          Write-Output "Contents of installer\output:"
          Get-ChildItem "installer\output\" -ErrorAction SilentlyContinue
          exit 1
        }

        Write-Output "Installer created successfully at: $installerPath"

    - name: Create release package
      shell: pwsh
      run: |
        # Create release directory
        New-Item -ItemType Directory -Force -Path release

        # Copy the installer (primary distribution method) - using dynamic version
        $installerFile = "installer\output\1Lap_Setup_v${{ steps.get_version.outputs.version }}.exe"
        Copy-Item $installerFile "release\"

        # Create a zip of the standalone executable bundle for advanced users
        Compress-Archive -Path "dist\1Lap\*" -DestinationPath "release\1Lap_Standalone.zip" -Force

        # Copy documentation
        Copy-Item "README.md" "release\"
        Copy-Item "USER_GUIDE.md" "release\"
        Copy-Item "CHANGELOG.md" "release\"
        Copy-Item "WINDOWS_BUILD_INSTRUCTIONS.md" "release\"

        # Generate version info based on trigger type
        if ("${{ github.event_name }}" -eq "pull_request") {
          $version = "1Lap PR #${{ github.event.pull_request.number }} ($(git rev-parse --short HEAD))`nBuild from: ${{ github.head_ref }}`nVersion: ${{ steps.get_version.outputs.version }}"
        } else {
          $version = "1Lap ${{ github.ref_name }}`nVersion: ${{ steps.get_version.outputs.version }}"
        }
        Set-Content -Path "release\VERSION.txt" -Value $version

        Write-Output "Release package created successfully!"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: 1Lap-windows-${{ github.event_name == 'pull_request' && format('PR{0}', github.event.pull_request.number) || github.ref_name }}
        path: release/

    - name: Comment on PR with build artifact
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const artifactName = `1Lap-windows-PR${{ github.event.pull_request.number }}`;
          const runId = context.runId;
          const repo = context.repo;

          const version = '${{ steps.get_version.outputs.version }}';
          const comment = `## âœ… Windows Build Complete

          The Windows executable and installer have been built and are ready for testing!

          **Version:** ${version}

          ### Download
          ðŸ“¦ [Download **${artifactName}**](https://github.com/${repo.owner}/${repo.repo}/actions/runs/${runId})

          Click the link above, scroll down to "Artifacts" section, and download the build.

          ### What's included
          - \`1Lap_Setup_v${version}.exe\` - **Windows installer (recommended)**
          - \`1Lap_Standalone.zip\` - Standalone executable bundle (for advanced users)
          - \`README.md\`, \`USER_GUIDE.md\`, \`CHANGELOG.md\`
          - \`VERSION.txt\` - Build information

          ### Testing checklist
          **Installer:**
          - [ ] Run installer on Windows
          - [ ] Verify Start Menu shortcuts created
          - [ ] Test custom output directory selection
          - [ ] Test upgrade scenario (if applicable)
          - [ ] Test uninstall with data preservation options

          **Functionality:**
          - [ ] Complete a player lap - verify no \`mCurrentET\` errors
          - [ ] Join multiplayer session
          - [ ] Wait for opponent to complete a lap
          - [ ] Check opponent lap filename has opponent's name
          - [ ] Check opponent CSV metadata has correct driver/car

          ---
          ðŸ¤– *Automated build from PR #${{ github.event.pull_request.number }}*`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: repo.owner,
            repo: repo.repo,
            body: comment
          });

    - name: Get release notes
      id: release_notes
      if: startsWith(github.ref, 'refs/tags/')
      shell: bash
      run: |
        # Extract version from tag (e.g., v0.2.0 -> 0.2.0)
        VERSION=${GITHUB_REF_NAME#v}

        # Look for RELEASE_NOTES_v{version}.md
        RELEASE_NOTES_FILE="RELEASE_NOTES_v${VERSION}.md"

        if [ -f "$RELEASE_NOTES_FILE" ]; then
          echo "Using $RELEASE_NOTES_FILE"
          echo "body_file=$RELEASE_NOTES_FILE" >> $GITHUB_OUTPUT
        else
          echo "No release notes file found, using default"
          echo "body_file=" >> $GITHUB_OUTPUT
        fi

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          installer/output/1Lap_Setup_v${{ steps.get_version.outputs.version }}.exe
          release/1Lap_Standalone.zip
          README.md
          USER_GUIDE.md
          CHANGELOG.md
          WINDOWS_BUILD_INSTRUCTIONS.md
        body_path: ${{ steps.release_notes.outputs.body_file }}
        body: |
          ## 1Lap ${{ github.ref_name }}

          ### Features
          - âœ… Automatic telemetry capture from Le Mans Ultimate (player + opponents)
          - âœ… System tray interface with start/stop/pause controls
          - âœ… Professional Windows installer with shortcuts
          - âœ… Opponent lap tracking (fastest lap only)
          - âœ… MVP format output (10-channel LMUTelemetry v3)
          - âœ… ~43Hz capture rate (optimal)
          - âœ… File size: ~1 MB per lap
          - âœ… Smart file naming with track, car, driver, lap time

          ### Installation (Recommended)

          **Option 1: Installer (Easy)**
          1. Download `1Lap_Setup_v${{ steps.get_version.outputs.version }}.exe`
          2. Run the installer and follow the wizard
          3. Choose your telemetry output directory (default: `Documents\1Lap Telemetry`)
          4. Launch from Start Menu
          5. Access system tray icon for controls

          **Option 2: Standalone Executable (Advanced)**
          1. Download `1Lap_Standalone.zip`
          2. Extract the zip file to a folder of your choice
          3. Run `1Lap.exe` from the extracted folder
          4. CSV files saved to `./telemetry_output/`

          ### Prerequisites
          1. **Install LMU Runtime Dependencies** (Required!)
            - Navigate to: `LMU/support/runtimes/`
            - Install all runtime installers (especially `vc_redist.x64.exe`)
            - Restart computer (recommended)
          2. **Enable rF2SharedMemoryMapPlugin** in LMU
            - Edit `Documents\Studio 397\UserData\<YourPlayer>\CustomPluginVariables.JSON`
            - Set `"Enabled": 1` for `rF2SharedMemoryMapPlugin`
            - This plugin is included with LMU (just needs to be enabled)

          ### Requirements
          - Windows 10/11 (64-bit)
          - Le Mans Ultimate installed
          - **Visual C++ Runtimes** (from LMU's support/runtimes folder)

          ### What's New
          See the release notes or CHANGELOG.md for details on what's new in this version.

          ### Documentation
          - See `USER_GUIDE.md` for detailed instructions
          - See `CHANGELOG.md` for full changelog
          - See `WINDOWS_BUILD_INSTRUCTIONS.md` to build from source
          - See `installer/README.md` for installer build instructions
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
